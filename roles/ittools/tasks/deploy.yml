---
- name: Ensure parent directory exists
  ansible.builtin.file:
    state: directory
    path: "{{ ittools_deploy_path }}"
    mode: "0700"

- name: Create directories
  ansible.builtin.file:
    state: directory
    path: "{{ ittools_deploy_path }}/{{ item.path }}"
    mode: "{{ item.mode }}"
  with_community.general.filetree: "../templates"
  when: item.state == 'directory'

- name: Template files
  ansible.builtin.template:
    src: "{{ item.src }}"
    dest: "{{ ittools_deploy_path }}/{{ item.path | regex_replace('\\.j2$', '') }}"
    mode: "{{ item.mode }}"
  with_community.general.filetree: "../templates"
  when: item.state == 'file'

- name: Enable backup timer
  ansible.builtin.systemd_service:
    scope: user
    service: backup@ittools.timer
    state: started
    enabled: true

- name: Start services
  community.docker.docker_compose_v2:
    project_src: "{{ ittools_deploy_path }}"
    remove_orphans: true
    pull: always

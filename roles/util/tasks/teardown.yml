---
- name: Disable systemd timers for {{ util_app }}
  ansible.builtin.systemd_service:
    scope: user
    service: "{{ timer }}@{{ util_app }}.timer"
    state: stopped
    enabled: false
    daemon_reload: true
  loop:
    - backup
    - docker-compose-up
  loop_control:
    loop_var: timer

- name: Check if deploy directory exists for {{ util_app }}
  ansible.builtin.stat:
    path: "{{ util_deploy_path }}"
  register: util_deploy_path_stat

- when: util_deploy_path_stat.stat.exists # noqa: name
  block:
    - name: Ensure services are stopped
      community.docker.docker_compose_v2:
        project_src: "{{ util_deploy_path }}"
        state: absent
        remove_volumes: true

    - name: Ensure deploy directory is removed
      ansible.builtin.file:
        dest: "{{ util_deploy_path }}"
        state: absent

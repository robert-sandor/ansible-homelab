---
# TODO: this unfortunately makes it so that the config is always changing given the random salt being added ...
# see if there's some kind of better solution
- name: Authelia hash secrets
  vars:
    to_hash:
      - "{{ core_authelia_portainer_secret }}"
      - "{{ core_authelia_grafana_secret }}"
      - "{{ core_authelia_vikunja_secret }}"
  block:
    - name: Authelia hash OIDC secret
      no_log: true
      ansible.builtin.shell:
        executable: /usr/bin/bash
        cmd: >-
          set -o pipefail;
          TMP=$(docker run --rm authelia/authelia:{{ core_authelia_version }} authelia crypto hash generate argon2 --password "{{ item }}");
          echo $TMP | awk -F ' ' '{ print $2 }'
      register: authelia_hashed_oidc_secret_results
      changed_when: false
      loop: "{{ to_hash }}"

    - name: Authelia save hashed secrets
      no_log: true
      ansible.builtin.set_fact:
        authelia_hashed_oidc_secrets: >-
          {{
          authelia_hashed_oidc_secrets | default({})
          | combine({item: authelia_hashed_oidc_secret_results.results[index].stdout})
          }}
      loop: "{{ to_hash }}"
      loop_control:
        index_var: index
